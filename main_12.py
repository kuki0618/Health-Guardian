# å¯¹main_11.pyçš„ä¿®æ”¹
# ä½¿ç”¨æ–‡ä»¶è¯»å…¥JSONæ•°æ®çš„æ–¹å¼å¤„ç†å¤šä¸ªå‘˜å·¥
# ç¤ºä¾‹æ–‡ä»¶employee_data.json

# ä½¿ç”¨æ–‡ä»¶è¯»å…¥JSONæ•°æ®çš„æ–¹å¼å¤„ç†å¤šä¸ªå‘˜å·¥
from openai import OpenAI
import json
from datetime import datetime

client = OpenAI(
    api_key="sk-fc28bd037f5744ed9daf31dcc7feb6a3",
    base_url="https://api.deepseek.com"
)

system_content = """
ä½ æ˜¯ä¸€ä¸ªèŒå·¥å¥åº·æç¤ºå°åŠ©æ‰‹ï¼Œ
ä¸»è¦ä»»åŠ¡æ—¶ç»“åˆå‘˜å·¥æ´»åŠ¨æ—¶é—´çš„æ•°æ®ï¼ˆå¦‚å·¥ä½ä¹…åæ—¶é•¿ï¼‰ï¼Œç”Ÿæˆä¸ªæ€§åŒ–å¥åº·æé†’ä¸å»ºè®®ï¼ˆå¦‚ä¼‘æ¯ã€è¡¥æ°´ã€è¿åŠ¨ï¼‰ã€‚

è¯·æ ¹æ®æä¾›çš„å‘˜å·¥å¥åº·æ•°æ®ç”Ÿæˆä¸ªæ€§åŒ–çš„å¥åº·æé†’ï¼š
1. é¦–å…ˆç¡®è®¤å‘˜å·¥èº«ä»½ï¼ˆå§“åã€éƒ¨é—¨ã€ç¼–å·ã€å·¥ä½ä¿¡æ¯ï¼‰
2. æ ¹æ®å–æ°´æ¯æ•°è¿›è¡Œå–æ°´æé†’ï¼š
   - å¦‚æœå–æ°´ä¸è¶³8æ¯ï¼Œæç¤ºå‘˜å·¥åŠæ—¶è¡¥å……æ°´æºæ‘„å…¥
   - å¦‚æœå·²ç»å–äº†8æ¯æˆ–ä»¥ä¸Šï¼Œè¡¨æ‰¬ä»–ä»¬å¹¶æç¤ºè¦åšæŒè¿™æ ·çš„å¥½ä¹ æƒ¯
3. æ ¹æ®ä¹…åèµ·å§‹æ—¶é—´å’Œå½“å‰æ—¶é—´ï¼Œè®¡ç®—è¿ç»­åçš„æ—¶é—´ï¼š
   - å¦‚æœåç€çš„æ—¶é—´ä¸çŸ­äº2ä¸ªå°æ—¶ï¼Œæç¤ºå‘˜å·¥ä¸è¦ä¹…åï¼Œèµ·èº«æ´»åŠ¨è‡³å°‘10åˆ†é’Ÿ
   - å¦‚æœåç€çš„æ—¶é—´å°äº2å°æ—¶ï¼Œæç¤ºå‘˜å·¥ä¸è¦ä¹…åï¼Œæ¯éš”ä¸€æ®µæ—¶é—´è¦èµ·èº«æ´»åŠ¨ä¸€ä¸‹

ä½ çš„è¯­æ°”è¦å¹³æ˜“è¿‘äººï¼Œæ ¹æ®å‘˜å·¥ç»™å‡ºçš„æ•°æ®è¿›è¡Œåˆç†çš„æç¤ºã€‚
å½“å‰æ—¶é—´ï¼š{current_time}
"""


def calculate_sit_duration(sit_start_time):
    """
    è®¡ç®—ä¹…åæ—¶é•¿ï¼ˆå°æ—¶ï¼‰
    """
    try:
        # æ£€æŸ¥æ˜¯å¦ä¸ºç©ºå€¼
        if not sit_start_time:
            return 0

        start_time = datetime.strptime(sit_start_time, "%Y-%m-%d %H:%M:%S")
        current_time = datetime.now()
        duration = (current_time - start_time).total_seconds() / 3600
        return duration

    except Exception as e:
        print(f"è®¡ç®—ä¹…åæ—¶é•¿æ—¶å‡ºé”™ï¼š{e}")
        return 0


def generate_health_tips(employee_data):
    # è·å–å½“å‰æ—¶é—´
    current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    # å‡†å¤‡ç³»ç»Ÿæ¶ˆæ¯ï¼ŒåŒ…å«å½“å‰æ—¶é—´
    system_msg = system_content.format(current_time=current_time)

    # è®¡ç®—ä¹…åæ—¶é•¿
    sit_duration = calculate_sit_duration(employee_data.get("sit_start_time", ""))
    employee_data["sit_duration_hours"] = round(sit_duration, 2)

    # å°†å‘˜å·¥æ•°æ®è½¬åŒ–ä¸ºJSONå­—ç¬¦ä¸²
    employee_data_str = json.dumps(employee_data, ensure_ascii=False, indent=2)

    messages = [
        {
            "role": "system",
            "content": system_msg
        },
        {
            "role": "user",
            "content": f"ä»¥ä¸‹æ˜¯å‘˜å·¥çš„å¥åº·æ•°æ®ï¼Œè¯·ç”Ÿæˆç›¸åº”çš„å¥åº·æç¤º: \n{employee_data_str}"
        }
    ]

    try:
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=messages,
            stream=False,
            temperature=1
        )

        ai_response = response.choices[0].message.content
        return ai_response

    except Exception as e:
        return f"è°ƒç”¨APIæ—¶å‡ºç°é”™è¯¯: {e}"


if __name__ == "__main__":
    try:
        # ä»æ–‡ä»¶è¯»å–JSONæ•°æ®çš„ç¤ºä¾‹
        with open("employee_data.json", "r", encoding="utf-8") as f:
            employee_data = json.load(f)

            # æ£€æŸ¥æ˜¯å¦ä¸ºå¤šä¸ªå‘˜å·¥çš„æ•°æ®
            if isinstance(employee_data, list):
                for employee in employee_data:
                    health_tips = generate_health_tips(employee)
                    print(f"å‘˜å·¥ {employee.get('name', 'æœªçŸ¥')} çš„å¥åº·æç¤º: ")
                    print(health_tips)
                    print("\n" + "=" * 50 + "\n")
            else:
                health_tips = generate_health_tips(employee_data)
                print("å¥åº·æç¤º: ")
                print(health_tips)
                print("\n")

    except FileNotFoundError:
        print("é”™è¯¯ï¼šæ‰¾ä¸åˆ° employee_data.json æ–‡ä»¶")
    except json.JSONDecodeError:
        print("é”™è¯¯ï¼šemployee_data.json æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®")
    except KeyboardInterrupt:
        print("\nç¨‹åºè¢«ç”¨æˆ·ä¸­æ–­")
    except Exception as e:
        print(f"ç¨‹åºæ‰§è¡Œå‡ºé”™: {e}")


# æœ€ç»ˆç»“æœè¾“å‡ºï¼š
# å¥åº·æç¤º:
# ### å‘˜å·¥å¥åº·æç¤º

# #### å¼ ä¸‰ï¼ˆæŠ€æœ¯éƒ¨ï¼Œç¼–å·TECH001ï¼Œå·¥ä½AåŒº-å·¥ä½10ï¼‰ï¼š
# - **å–æ°´æé†’**ï¼šæ‚¨ä»Šå¤©å–äº†5æ¯æ°´ï¼Œå»ºè®®åŠæ—¶è¡¥å……æ°´æºæ‘„å…¥ï¼Œæ¯å¤©è‡³å°‘8æ¯æ°´ä»¥ä¿æŒèº«ä½“æ°´åˆ†å¹³è¡¡å“¦ï¼
# - **ä¹…åæé†’**ï¼šæ‚¨ä»15:31å¼€å§‹ä¹…åï¼Œåˆ°å½“å‰æ—¶é—´17:04ï¼Œå·²è¿ç»­åäº†çº¦1å°æ—¶33åˆ†é’Ÿã€‚è™½ç„¶æ—¶é—´è¿˜ä¸ç®—å¤ªé•¿ï¼Œä½†å»ºè®®æ¯éš”ä¸€æ®µæ—¶é—´å°±èµ·èº«æ´»åŠ¨ä¸€ä¸‹ï¼Œä¼¸å±•èº«ä½“ï¼Œé¿å…é•¿æ—¶é—´ä¿æŒåŒä¸€å§¿åŠ¿ã€‚

# #### æå››ï¼ˆå¸‚åœºéƒ¨ï¼Œç¼–å·MKT002ï¼Œå·¥ä½BåŒº-å·¥ä½5ï¼‰ï¼š
# - **å–æ°´æé†’**ï¼šæ‚¨ä»Šå¤©å–äº†3æ¯æ°´ï¼Œå–æ°´ä¸è¶³å“¦ï¼è¯·è®°å¾—åŠæ—¶è¡¥å……æ°´åˆ†ï¼Œæ¯å¤©8æ¯æ°´æœ‰åŠ©äºæé«˜æ³¨æ„åŠ›å’Œå¥åº·ã€‚
# - **ä¹…åæé†’**ï¼šæ‚¨ä»09:15å¼€å§‹ä¹…åï¼Œåˆ°å½“å‰æ—¶é—´17:04ï¼Œå·²è¿ç»­åäº†çº¦7å°æ—¶49åˆ†é’Ÿã€‚è¿™å·²ç»è¶…è¿‡2å°æ—¶äº†ï¼Œå»ºè®®ç«‹å³èµ·èº«æ´»åŠ¨è‡³å°‘10åˆ†é’Ÿï¼Œèµ°åŠ¨ä¸€ä¸‹æˆ–åšäº›ä¼¸å±•ï¼Œç¼“è§£è‚Œè‚‰ç–²åŠ³ã€‚

# #### ç‹äº”ï¼ˆè´¢åŠ¡éƒ¨ï¼Œç¼–å·FIN003ï¼Œå·¥ä½CåŒº-å·¥ä½3ï¼‰ï¼š
# - **å–æ°´æé†’**ï¼šå¤ªæ£’äº†ï¼æ‚¨ä»Šå¤©å·²ç»å–äº†9æ¯æ°´ï¼Œè¶…è¿‡äº†æ¨èé‡ã€‚ç»§ç»­ä¿æŒè¿™æ ·çš„å¥½ä¹ æƒ¯ï¼Œè¿™å¯¹æ‚¨çš„å¥åº·å’Œæ´»åŠ›å¾ˆæœ‰å¸®åŠ©ï¼
# - **ä¹…åæé†’**ï¼šæ‚¨ä»08:45å¼€å§‹ä¹…åï¼Œåˆ°å½“å‰æ—¶é—´17:04ï¼Œå·²è¿ç»­åäº†çº¦8å°æ—¶19åˆ†é’Ÿã€‚è¿™è¿œè¶…è¿‡2å°æ—¶ï¼Œå¼ºçƒˆå»ºè®®æ‚¨èµ·èº«æ´»åŠ¨ä¸€ä¸‹ï¼Œè‡³å°‘ä¼‘æ¯10åˆ†é’Ÿï¼Œèµ°åŠ¨æˆ–åšç®€å•çš„ä¼¸å±•è¿åŠ¨ï¼Œä»¥é¿å…ä¹…åå¸¦æ¥çš„å¥åº·é£é™©ã€‚

# **é€šç”¨å»ºè®®**ï¼š
# æ— è®ºä¹…åæ—¶é—´é•¿çŸ­ï¼Œéƒ½å»ºè®®æ¯éš”30-60åˆ†é’Ÿå°±çŸ­æš‚æ´»åŠ¨ä¸€ä¸‹ã€‚å¤šå–æ°´ã€å¸¸æ´»åŠ¨ï¼Œè®©å·¥ä½œæ›´é«˜æ•ˆï¼Œèº«ä½“æ›´å¥åº·ï¼ ğŸ˜Š
